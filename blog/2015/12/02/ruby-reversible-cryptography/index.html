
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Rubyで可逆暗号 - mitaku.log</title>
	<meta name="author" content="Takumi MIURA">

	
	<meta name="description" content="Rubyで可逆暗号 はじめに これは 【その2】ドリコム Advent Calendar 2015 2日目の記事です 1日目の記事はarihhさんの「カンバンの管理に改善を加えたら加速した話 - arihhのブログ」です 【その1】ドリコム Advent Calendar 2015 - &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="mitaku.log" type="application/atom+xml">
	
	<link rel="canonical" href="http://mitaku.github.com/blog/2015/12/02/ruby-reversible-cryptography/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		document.write("<img src='http://www.gravatar.com/avatar/" + MD5("mitaku1104@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;'");
	</script>
</div>
<h1><a href="/">mitaku.log</a></h1>
<p class="subtitle"></p>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		
		
		<a class="twitter" href="http://twitter.com/mitaku" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/mitaku" title="GitHub">GitHub</a>
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Rubyで可逆暗号</h1>
	<div class="entry-content" itemprop="articleBody"><h2>はじめに</h2>

<p>これは <a href="http://www.adventar.org/calendars/1044">【その2】ドリコム Advent Calendar 2015</a> 2日目の記事です</p>

<p>1日目の記事はarihhさんの「<a href="http://arihh.hatenablog.jp/entry/2015/12/01/005948">カンバンの管理に改善を加えたら加速した話 - arihhのブログ</a>」です</p>

<p><a href="http://www.adventar.org/calendars/1043">【その1】ドリコム Advent Calendar 2015 - Adventar</a> もあります!</p>

<p>めっちゃブログ書くのが久しぶりで、このブログの更新の仕方を忘れてたりしました。</p>

<p><strong>あと、モンハンやりたい。モンハンやりたい、モンハンやりたい</strong></p>

<p><em>※エンジニア向けの記事です</em></p>

<h2>本題 - 「Rubyで可逆暗号-その情報を知りたくない僕らは」</h2>

<p>生データとして扱いたくない情報を難読化する話をします!</p>

<p><em>※エンジニア向けの記事です</em></p>

<h3>(エンジニアの自分が)生データとして扱いたくない情報</h3>

<ul>
<li>何かのアカウント(ID/PW)</li>
<li>自分のものじゃない秘密鍵</li>
<li>ユニークなギフトコード</li>
<li>etc&hellip;</li>
</ul>


<p>などなど。思い当たるものはないでしょうか？</p>

<hr />

<p>最近、ドリコムではAWSの活用事例が増えてきました。</p>

<p>AWSを便利に活用させていただいているのですが、必然的にアクセスキーやシークレットキーを取り扱う必要がでてきます。</p>

<p>アクセスキーとシークレットキーが漏れたりすると何が起こるかわかりません。</p>

<p><strong>情報漏えいはシステムよりも人間が原因になることのほうが多い</strong>と教わってきたので</p>

<p>個人的には知らなくてよければ知らないまま過ごしたい情報です。</p>

<p>なので、少しでも心を穏やかにするために、生のデータを扱うの避けて、一工夫して運用しています。</p>

<h3>Rubyで可逆暗号</h3>

<h4>ActiveSupport::MessageEncryptor</h4>

<p>みんなだいすき<code>ActiveSupport</code></p>

<p>それ、<code>ActiveSupport::MessageEncryptor</code>でできるよ!!</p>

<p><a href="http://qiita.com/kengos@github/items/e8ea8f71c47852fde48b">Railsで簡単可逆暗号(ActiveSupport::MessageEncryptor)</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">secret</span> <span class="o">=</span> <span class="ss">SecureRandom</span><span class="p">:</span><span class="ss">:hex</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; &quot;13f3bab71cc735eea473e8fd225bb04232d23eadf194bd066179e09871fdf9244b454c38ebd6715e03b903d595b8ac5d75488dff2d9d48f3d2eb5e9a026ebbb4ef799e9596376f63a49640e9336f9b011fa8972a763a6d1fe13b5d4d096a34cdeba91636c86b70e9a88fab56f2a4f6b19eee801ac0d1e3415bb17b8f92f0133b&quot;</span>
</span><span class='line'><span class="n">encryptor</span> <span class="o">=</span> <span class="o">::</span><span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:MessageEncryptor</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="ss">cipher</span><span class="p">:</span> <span class="s1">&#39;aes-256-cbc&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">encrypt_message</span> <span class="o">=</span> <span class="n">encryptor</span><span class="o">.</span><span class="n">encrypt_and_sign</span><span class="p">(</span><span class="s2">&quot;target_message&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; &quot;QjlkVndyeERrV3BUcW1paVVkTDJQTWhzV3R5OEV3N3JsR2FnV0VxRjdCTT0tLUJFSmdLTUNFbHdmZHhWcjZUQllUR0E9PQ==--6f6d897b52cfad56d9a31f8a19d44481e5343f18&quot;</span>
</span><span class='line'><span class="n">encryptor</span><span class="o">.</span><span class="n">decrypt_and_verify</span><span class="p">(</span><span class="n">encrypt_message</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;target_message&quot;</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>便利ですね。
これだけだと芸がないので、ドリコムでの事例を紹介します!</p>

<h4>ReversibleCryptography</h4>

<p><a href="https://github.com/mitaku/reversible_cryptography">reversible_cryptography</a>
という自作gemを使ってます。</p>

<p>READMEより</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">secret</span> <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
</span><span class='line'><span class="n">encrypted_message</span> <span class="o">=</span> <span class="ss">ReversibleCryptography</span><span class="p">:</span><span class="ss">:Message</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="s2">&quot;target_message&quot;</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
</span><span class='line'><span class="c1">#=&gt; &quot;md5:388eeae24576572f946e9043a2118b2d:salt:161-225-182-109-143-90-1-28:aes-256-cfb:DHY6DF3+iFzH36FMbeI=&quot;</span>
</span><span class='line'><span class="ss">ReversibleCryptography</span><span class="p">:</span><span class="ss">:Message</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;target_message&quot;</span>
</span><span class='line'><span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>簡単ですね。</p>

<ul>
<li><em>※上記例とは暗号化方式等,諸々違うため堅牢度合いは違います</em></li>
<li><em>※暗号化するものが簡単な英単語だったりする場合,MD5から逆引きされる可能性があります</em></li>
<li><em>※パスワードの強度は高いものを利用しています</em></li>
</ul>


<h3>もう一工夫</h3>

<p>Railsに限った話ではないですがアプリでの利用方法も記載します</p>

<p>各種設定はyamlファイルに記載することが多く、
このようにYAMLのプライベートタイプを追加し環境変数を利用するようにしています。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ReversibleEncryptedString</span> <span class="o">&lt;</span> <span class="no">BasicObject</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@str</span> <span class="o">=</span> <span class="n">str</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">decrypted_string</span>
</span><span class='line'>    <span class="vi">@raw</span> <span class="o">||=</span> <span class="o">::</span><span class="ss">ReversibleCryptography</span><span class="p">:</span><span class="ss">:Message</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="vi">@str</span><span class="p">,</span> <span class="o">::</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;REVERSIBLE_CRYPTOGRAPY_SECRET&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">alias_method</span> <span class="ss">:to_s</span><span class="p">,</span> <span class="ss">:decrypted_string</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="n">decrypted_string</span><span class="o">.</span><span class="n">__send__</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">YAML</span><span class="o">.</span><span class="n">add_private_type</span><span class="p">(</span><span class="s2">&quot;Encrypted&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">_type</span><span class="p">,</span> <span class="n">val</span><span class="o">|</span>
</span><span class='line'>  <span class="no">ReversibleEncryptedString</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">aws</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">endpoint</span><span class="p-Indicator">:</span> <span class="s">&quot;ec2.ap-northeast-1.amazonaws.com&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">access_key_id</span><span class="p-Indicator">:</span> <span class="kt">!x-private</span><span class="l-Scalar-Plain">:Encrypted &quot;md5:109a42207275ce753e4923575ace3e12:salt:255-105-253-88-5-107-47-24:aes-256-cfb:4n++p1w8WZrjzmjna8W1mqh6PSA=&quot;</span>
</span><span class='line'>  <span class="l-Scalar-Plain">secret_access_key</span><span class="p-Indicator">:</span> <span class="kt">!x-private</span><span class="l-Scalar-Plain">:Encrypted &quot;md5:7844e3da7a807eb915207f7a36d4087b:salt:54-109-31-32-93-207-203-85:aes-256-cfb:l1OeNofj0C+vlsWfPfrTwQ==&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>環境変数の設定には<a href="https://github.com/bkeepers/dotenv">Dotenv</a>を利用しているところもあります。</p>

<h3>ReversibleCryptographyの活用プロダクト</h3>

<p>弊社sue445さんのgemでも利用されています!</p>

<ul>
<li><a href="https://github.com/sue445/itamae-plugin-resource-encrypted_remote_file">itamae-plugin-resource-encrypted_remote_file gem</a></li>
<li><a href="http://sue445.hatenablog.com/entry/2015/05/09/185807">itamae-plugin-resource-encrypted_remote_file を作った</a></li>
</ul>


<h2>おわりに</h2>

<ul>
<li><strong>情報漏えいは人が原因のほうが多い!</strong></li>
<li>意識をしつつ、健全な開発をしましょう!</li>
<li>知りたくない情報は暗号化してからもらいましょう!</li>
<li>可逆暗号ができる<a href="https://github.com/mitaku/reversible_cryptography">ReversibleCryptography</a>gemの紹介をしました</li>
<li>気が向いたら使ってみてもらえれば幸いです!</li>
</ul>


<p>ということで次はnakajiさんです!</p>
</div>

</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_counter addthis_pill_style"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2015 - Takumi MIURA -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->







		</div>
	</div>
</body>
</html>
